- name: Apply repo php-qa standards
  hosts: localhost
  connection: local
  gather_facts: no

  tasks:
    - name: Include task set_facts
      include_tasks: set_facts.yaml
    
    - name: Generate .php-cs-fixer.dist.php file
      ansible.builtin.template:
        src: "{{ './templates/php-qa/php-cs-fixer.dist.php.j2' }}"
        dest: "{{ repo.path + '/.php-cs-fixer.dist' }}"
      vars:
        phpstan_parameters_paths: "{{ repo_info.ansible_facts.repo.phpqa.phpneon_paths }}"
    
    - name: Generate phpstan.neon file
      ansible.builtin.template:
        src: "{{ './templates/php-qa/phpstan.neon.j2' }}"
        dest: "{{ repo.path + '/phpstan.neon' }}"
      vars:
        phpstan_parameters_level: "{{ repo_info.ansible_facts.repo.phpqa.phpstan_parameters_level  }}"
        phpstan_parameters_paths: "{{ repo_info.ansible_facts.repo.phpqa.php_cs_fixer_paths }}"
  
    - name: Generate reviewdog.yaml file
      ansible.builtin.template:
        src: "{{ './templates/php-qa/reviewdog.yaml.j2' }}"
        dest: "{{ repo.path + '/.reviewdog.yaml' }}"
      vars:
        php_cs_fixer_config_file_path: "{{ repo.path + '/.php-cs-fixer.dist.php' }}"
      
    - name: Append file name to .gitignore
      lineinfile:
        path: "{{ repo.path + '/.gitignore' }}"
        line: "{{ item }}"
      with_items:
        - .php-cs-fixer.cache
        - /tmp-phpqa

    - name: Download local-php-security-checker
      get_url:
        url: "https://github.com/fabpot/local-php-security-checker/releases/download/v2.0.6/local-php-security-checker_2.0.6_darwin_amd64"
        dest: "{{ repo.path + '/local-php-security-checker' }}"
        mode: "0755"

    - name: Generate yaml-lint.yaml file
      ansible.builtin.template:
        src: "{{ './templates/php-qa/yaml-lint-config.yaml.j2' }}"
        dest: "{{ repo.path + '/yaml-lint.yaml' }}"

    - name: Generate twigcs.yaml file
      ansible.builtin.template:
        src: "{{ './templates/php-qa/twigcs.yaml.j2' }}"
        dest: "{{ repo.path + '/twigcs.yaml' }}"
